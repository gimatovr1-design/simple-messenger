<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç üëã</h3>

<div id="nickBox">
    <input id="nickInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫" autocomplete="off">
    <button onclick="setNick()">OK</button>
</div>

<div class="layout">

    <div id="users">
        <b>–û–Ω–ª–∞–π–Ω</b>
        <ul id="userList"></ul>
    </div>

    <div class="chatBox">
        <div id="chat"></div>

        <div class="inputBox">
            <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ üòä">
            <input type="file" id="fileInput" accept="image/*,video/*">
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <div style="margin-top:6px">
            <span onclick="addEmoji('üòÄ')">üòÄ</span>
            <span onclick="addEmoji('üòÇ')">üòÇ</span>
            <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span onclick="addEmoji('üî•')">üî•</span>
            <span onclick="addEmoji('üëç')">üëç</span>
        </div>
    </div>

</div>

<script>
let myNick = "";
let users = new Set();

let ws = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") +
    location.host + "/ws"
);

ws.onmessage = (event) => {
    let data;
    try { data = JSON.parse(event.data); } catch { return; }

    if (data.type === "system") {
        addSystem(data.text);
        return;
    }

    if (data.type === "message") {
        users.add(data.nick);
        renderUsers();

        const side = data.nick === myNick ? "me" : "other";

        if (typeof data.text === "string") {
            addMessage(data.nick, data.text, side);
            return;
        }

        if (data.text.type === "text") {
            addMessage(data.nick, data.text.data, side);
        }

        if (data.text.type === "file") {
            if (data.text.mime.startsWith("image")) {
                addMessage(
                    data.nick,
                    `<img src="${data.text.data}" style="max-width:220px;border-radius:6px">`,
                    side
                );
            } else if (data.text.mime.startsWith("video")) {
                addMessage(
                    data.nick,
                    `<video src="${data.text.data}" controls style="max-width:240px;border-radius:6px"></video>`,
                    side
                );
            }
        }
    }
};

function setNick() {
    const nick = nickInput.value.trim();
    if (!nick) return;
    myNick = nick;
    ws.send("/nick " + nick);
    nickBox.style.display = "none";
}

function sendMessage() {
    if (messageInput.value.trim()) {
        ws.send(messageInput.value);
        messageInput.value = "";
    }

    const file = fileInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = () => {
            ws.send(JSON.stringify({
                type: "file",
                name: file.name,
                mime: file.type,
                data: reader.result
            }));
        };
        reader.readAsDataURL(file);
        fileInput.value = "";
    }
}

messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});

function addEmoji(e) {
    messageInput.value += e;
    messageInput.focus();
}

function addMessage(nick, text, side) {
    const chat = document.getElementById("chat");

    const msg = document.createElement("div");
    msg.className = "msg " + side;

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = nick[0].toUpperCase();

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = `<b>${nick}</b><br>${text}`;

    msg.appendChild(avatar);
    msg.appendChild(bubble);

    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
}

function addSystem(text) {
    const chat = document.getElementById("chat"); // ‚úÖ –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê ‚Äî –ö–õ–Æ–ß
    const div = document.createElement("div");
    div.className = "system";
    div.textContent = text;
    chat.appendChild(div);
}

function renderUsers() {
    userList.innerHTML = "";
    users.forEach(nick => {
        const li = document.createElement("li");
        li.innerHTML = `<span class="dot"></span>${nick}`;
        userList.appendChild(li);
    });
}
</script>

<style>
body {
    margin: 0;
    padding: 10px;
    min-height: 100vh;
    font-family: system-ui, sans-serif;
    color: #fff;
    background: linear-gradient(120deg,#7c3aed,#06b6d4,#ec4899);
}

.layout {
    display: flex;
    gap: 10px;
}

#users {
    width: 160px;
    background: rgba(0,0,0,.45);
    padding: 8px;
    border-radius: 8px;
}

#chat {
    height: 320px;
    overflow-y: auto;
    background: rgba(0,0,0,.45);
    border-radius: 8px;
    padding: 10px;
}

.msg {
    display: flex;
    margin-bottom: 8px;
}

.msg.me {
    flex-direction: row-reverse;
}

.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255,255,255,.2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 6px;
}

.bubble {
    max-width: 65%;
    padding: 6px 10px;
    border-radius: 10px;
    background: rgba(0,255,255,.35);
}

.msg.other .bubble {
    background: rgba(255,0,255,.35);
}

.system {
    text-align: center;
    font-size: 13px;
    opacity: .8;
}

.inputBox {
    display: flex;
    gap: 6px;
    margin-top: 6px;
}

input, button {
    padding: 6px;
}
</style>

</body>
</html>

