<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>

<style>
body { font-family: Arial; background: #222; color: #fff; }
#online li { cursor: pointer; padding: 5px; }
video { width: 240px; border-radius: 10px; margin: 5px; }
</style>
</head>

<body>

<h2>Онлайн</h2>
<ul id="online"></ul>

<div id="chat"></div>

<input id="msg" placeholder="Сообщение">
<button onclick="send()">Отправить</button>

<h3>Видеозвонок</h3>
<video id="local" autoplay muted></video>
<video id="remote" autoplay></video>

<script>
const ws = new WebSocket(`ws://${location.host}/ws`);
const rtc = new WebSocket(`ws://${location.host}/webrtc`);

let nick = prompt("Ник:");
ws.onopen = () => ws.send(JSON.stringify({type:"nick", nick}));

let pc;
let currentCallUser = null;

ws.onmessage = e => {
    const data = JSON.parse(e.data);

    if (data.type === "message") {
        chat.innerHTML += `<div><b>${data.nick}</b>: ${data.text}</div>`;
    }

    if (data.type === "video_call") {
        currentCallUser = data.from;
        startCall();
    }
};

function send() {
    ws.send(JSON.stringify({
        type:"message",
        nick,
        text: msg.value
    }));
    msg.value = "";
}

function callUser(user) {
    currentCallUser = user;
    ws.send(JSON.stringify({type:"video_call", to:user}));
    startCall();
}

function startCall() {
    pc = new RTCPeerConnection();

    pc.onicecandidate = e => {
        if (e.candidate) rtc.send(JSON.stringify(e.candidate));
    };

    pc.ontrack = e => remote.srcObject = e.streams[0];

    navigator.mediaDevices.getUserMedia({video:true,audio:true})
        .then(stream => {
            local.srcObject = stream;
            stream.getTracks().forEach(t => pc.addTrack(t, stream));
        });

    pc.createOffer()
        .then(o => pc.setLocalDescription(o))
        .then(() => rtc.send(JSON.stringify(pc.localDescription)));
}

rtc.onmessage = async e => {
    const data = JSON.parse(e.data);

    if (data.type === "offer") {
        pc = new RTCPeerConnection();
        pc.ontrack = e => remote.srcObject = e.streams[0];
        pc.onicecandidate = e => e.candidate && rtc.send(JSON.stringify(e.candidate));

        const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        local.srcObject = stream;
        stream.getTracks().forEach(t => pc.addTrack(t, stream));

        await pc.setRemoteDescription(data);
        const ans = await pc.createAnswer();
        await pc.setLocalDescription(ans);
        rtc.send(JSON.stringify(ans));
    }

    if (data.type === "answer") await pc.setRemoteDescription(data);
    if (data.candidate) await pc.addIceCandidate(data);
};

</script>

</body>
</html>
