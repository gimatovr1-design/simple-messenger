<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<h3>Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ñ‡Ð°Ñ‚ ðŸ‘‹</h3>

<div id="nickBox">
    <input id="nickInput" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¸Ðº" autocomplete="off">
    <button onclick="setNick()">OK</button>
</div>

<div class="layout">

    <div id="users">
        <b>ÐžÐ½Ð»Ð°Ð¹Ð½</b>
        <ul id="userList"></ul>
        <button onclick="startVideo()" style="margin-top:6px;width:100%">ðŸ“¹ Ð’Ð¸Ð´ÐµÐ¾Ð·Ð²Ð¾Ð½Ð¾Ðº</button>
    </div>

    <div class="chatBox">
        <div id="chat"></div>

        <div id="emojiPanel"></div>

        <div class="inputBox">
            <button onclick="toggleEmoji()">ðŸ˜€</button>
            <input type="file" id="fileInput" accept="image/*,video/*">
            <input id="messageInput" placeholder="Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ">
            <button onclick="sendMessage()">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
        </div>

        <div class="videoBox">
            <video id="localVideo" autoplay muted playsinline></video>
            <video id="remoteVideo" autoplay playsinline></video>
        </div>
    </div>

</div>

<script>
let myNick = "";
let users = new Set();

// ===== CHAT WS =====
const ws = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") +
    location.host + "/ws"
);

// ===== WEBRTC WS =====
const rtcWs = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") +
    location.host + "/webrtc"
);

ws.onmessage = (event) => {
    let data;
    try { data = JSON.parse(event.data); } catch { return; }

    if (data.type === "system") {
        handleSystem(data.text);
        return;
    }

    if (data.type === "message") {
        users.add(data.nick);
        renderUsers();
        const side = data.nick === myNick ? "me" : "other";
        addMessage(data.nick, data.text, side);
    }
};

// ================== CHAT ==================
function setNick() {
    const nick = nickInput.value.trim();
    if (!nick) return;
    myNick = nick;
    ws.send("/nick " + nick);
    nickBox.style.display = "none";
}

function sendMessage() {
    const text = messageInput.value.trim();
    const file = fileInput.files[0];

    if (file) {
        const reader = new FileReader();
        reader.onload = () => ws.send(reader.result);
        reader.readAsDataURL(file);
        fileInput.value = "";
        messageInput.value = "";
        return;
    }

    if (text) {
        ws.send(text);
        messageInput.value = "";
    }
}

messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});

function addMessage(nick, text, side) {
    const msg = document.createElement("div");
    msg.className = "msg " + side;

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = nick[0].toUpperCase();

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    if (text.startsWith("data:image")) {
        bubble.innerHTML = `<b>${nick}</b><br><img src="${text}" style="max-width:240px;border-radius:8px">`;
    } else if (text.startsWith("data:video")) {
        bubble.innerHTML = `<b>${nick}</b><br><video src="${text}" controls style="max-width:240px;border-radius:8px;background:#000"></video>`;
    } else {
        bubble.innerHTML = `<b>${nick}</b><br>${text}`;
    }

    msg.appendChild(avatar);
    msg.appendChild(bubble);
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
}

function handleSystem(text) {
    const div = document.createElement("div");
    div.className = "system";
    div.textContent = text;
    chat.appendChild(div);
}

function renderUsers() {
    userList.innerHTML = "";
    users.forEach(u => {
        const li = document.createElement("li");
        li.textContent = u;
        userList.appendChild(li);
    });
}

// ================== EMOJI ==================
const emojis = "ðŸ˜€ ðŸ˜ ðŸ˜‚ ðŸ¤£ ðŸ˜ƒ ðŸ˜„ ðŸ˜… ðŸ˜† ðŸ˜‰ ðŸ˜Š ðŸ˜‹ ðŸ˜Ž ðŸ˜ ðŸ˜˜ ðŸ˜— ðŸ˜™ ðŸ˜š ðŸ™‚ ðŸ¤— ðŸ¤© ðŸ¤” ðŸ¤¨ ðŸ˜ ðŸ˜‘ ðŸ˜¶ ðŸ™„ ðŸ˜ ðŸ˜£ ðŸ˜¥ ðŸ˜® ðŸ¤ ðŸ˜¯ ðŸ˜ª ðŸ˜« ðŸ˜´ ðŸ˜Œ ðŸ˜› ðŸ˜œ ðŸ˜ ðŸ¤¤ ðŸ˜’ ðŸ˜“ ðŸ˜” ðŸ˜• ðŸ™ƒ ðŸ¥° ðŸ˜‡ ðŸ¤ª ðŸ˜¡ ðŸ˜  ðŸ¤¬ ðŸ˜¤ ðŸ˜­ ðŸ˜¢ ðŸ˜± ðŸ˜¨ ðŸ˜° ðŸ˜² ðŸ¤¯ ðŸ‘ ðŸ‘Ž ðŸ‘ ðŸ™Œ ðŸ¤ ðŸ’ª ðŸ™ â¤ ðŸ’” ðŸ’– ðŸ’• ðŸ’¯ ðŸ”¥ ðŸŽ‰".split(" ");

function toggleEmoji() {
    emojiPanel.style.display = emojiPanel.style.display === "block" ? "none" : "block";
}

emojis.forEach(e => {
    const span = document.createElement("span");
    span.textContent = e;
    span.onclick = () => {
        messageInput.value += e;
        messageInput.focus();
    };
    emojiPanel.appendChild(span);
});

// ================== VIDEO ==================
let pc;
let localStream;
const room = "global-room";

rtcWs.onmessage = async e => {
    const data = JSON.parse(e.data);
    if (!pc) createPC();

    if (data.type === "video_offer") {
        await pc.setRemoteDescription(data.offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        rtcWs.send(JSON.stringify({ type:"video_answer", room, answer }));
    }

    if (data.type === "video_answer") {
        await pc.setRemoteDescription(data.answer);
    }

    if (data.type === "video_ice") {
        await pc.addIceCandidate(data.candidate);
    }
};

function createPC() {
    pc = new RTCPeerConnection();
    pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
    pc.onicecandidate = e => {
        if (e.candidate) {
            rtcWs.send(JSON.stringify({
                type: "video_ice",
                room,
                candidate: e.candidate
            }));
        }
    };
}

async function startVideo() {
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    localVideo.srcObject = localStream;

    createPC();
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    rtcWs.send(JSON.stringify({ type:"video_join", room }));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    rtcWs.send(JSON.stringify({ type:"video_offer", room, offer }));
}
</script>

<style>
body {
    margin: 0;
    padding: 10px;
    min-height: 100vh;
    font-family: system-ui, sans-serif;
    color: #fff;
    background: linear-gradient(120deg,#7f00ff,#00c6ff,#ff0080);
}

.layout { display: flex; gap: 10px; }

#users {
    width: 160px;
    background: rgba(0,0,0,.45);
    padding: 8px;
    border-radius: 8px;
}

.chatBox { flex: 1; }

#chat {
    height: 280px;
    overflow-y: auto;
    background: rgba(0,0,0,.45);
    border-radius: 8px;
    padding: 10px;
}

.videoBox {
    display: flex;
    gap: 6px;
    margin-top: 6px;
}

video {
    width: 50%;
    border-radius: 8px;
    background: #000;
}

.msg { display: flex; margin-bottom: 8px; }
.msg.me { flex-direction: row-reverse; }

.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255,255,255,.2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 6px;
    font-weight: bold;
}

.bubble {
    max-width: 65%;
    padding: 6px 10px;
    border-radius: 10px;
    background: rgba(0,255,255,.35);
}

.msg.other .bubble {
    background: rgba(255,0,255,.35);
}

.system {
    text-align: center;
    font-size: 13px;
    opacity: .8;
}

.inputBox {
    display: flex;
    gap: 6px;
    margin-top: 6px;
}

#emojiPanel {
    display: none;
    background: rgba(0,0,0,.5);
    padding: 6px;
    border-radius: 8px;
    margin-top: 6px;
    max-height: 120px;
    overflow-y: auto;
}

#emojiPanel span {
    cursor: pointer;
    font-size: 20px;
    padding: 4px;
    display: inline-block;
}

input, button {
    padding: 6px;
}
</style>

</body>
</html>
