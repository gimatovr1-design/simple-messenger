<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    height: 100vh;
}

#users {
    width: 220px;
    border-right: 1px solid #ccc;
    padding: 10px;
    overflow-y: auto;
}

.user {
    padding: 6px;
    cursor: pointer;
}

.user:hover {
    background: #eee;
}

.user.active {
    background: #ddd;
    font-weight: bold;
}

#chat {
    flex: 1;
    display: flex;
    flex-direction: column;
}

#messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
}

#input {
    display: flex;
    border-top: 1px solid #ccc;
}

#input input {
    flex: 1;
    padding: 10px;
}

#input button {
    padding: 10px;
}
</style>
</head>

<body>

<div id="users"></div>

<div id="chat">
    <div id="messages"></div>
    <div id="input">
        <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script>
/* ====== –ù–ê–°–¢–†–û–ô–ö–ò ====== */
const username = prompt("–í–≤–µ–¥–∏ –Ω–∏–∫").trim().toLowerCase();
const ws = new WebSocket(`wss://${location.host}/ws/${username}`);

/* ====== –°–û–°–¢–û–Ø–ù–ò–ï ====== */
let selectedUser = null;

/* ====== DOM ====== */
const usersDiv = document.getElementById("users");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msg");

/* ====== –®–ò–§–†–û–í–ê–ù–ò–ï (—É–ø—Ä–æ—â–µ–Ω–æ, –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ AES) ====== */
function encrypt(text) {
    return btoa(text);
}
function decrypt(text) {
    return atob(text);
}

/* ====== WEBSOCKET ====== */
ws.onopen = () => {
    console.log("WS connected");
};

ws.onmessage = (e) => {
    console.log("RAW WS:", e.data);

    let data;
    try {
        data = JSON.parse(e.data);
    } catch (err) {
        console.warn("NOT JSON FROM SERVER:", e.data);
        return; // üí™ –∑–∞—â–∏—Ç–∞, –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–∞–¥–∞–µ—Ç
    }

    if (data.type === "users") {
        renderUsers(data.users);
        return;
    }

    if (data.type === "message") {
        addMessage(data.from + ": " + decrypt(data.text));
    }
};

ws.onclose = () => {
    console.log("WS closed");
};

/* ====== UI ====== */
function renderUsers(users) {
    usersDiv.innerHTML = "";

    users.forEach(u => {
        if (u === username) return;

        const div = document.createElement("div");
        div.textContent = u;
        div.className = "user";

        div.onclick = () => {
            selectedUser = u;
            document.querySelectorAll(".user")
                .forEach(el => el.classList.remove("active"));
            div.classList.add("active");
        };

        usersDiv.appendChild(div);
    });
}

function sendMessage() {
    if (!selectedUser) {
        alert("–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        return;
    }

    const text = msgInput.value.trim();
    if (!text) return;

    ws.send(JSON.stringify({
        type: "message",
        to: selectedUser,
        text: encrypt(text)
    }));

    addMessage("–Ø: " + text);
    msgInput.value = "";
}

function addMessage(text) {
    const div = document.createElement("div");
    div.textContent = text;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}
</script>

</body>
</html>
