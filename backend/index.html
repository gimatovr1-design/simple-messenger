<script>
const text = document.getElementById("text");
const messages = document.getElementById("messages");
const users = document.getElementById("users");
const emojiBtn = document.getElementById("emojiBtn");
const emojiPanel = document.getElementById("emojiPanel");
const fileInput = document.getElementById("fileInput");

let nick = "";
while (!nick) nick = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫");

const ws = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws"
);

ws.onopen = () => {
    ws.send(JSON.stringify({ type: "nick", nick }));
};

ws.onmessage = e => {
    const data = JSON.parse(e.data);

    // ===== –æ–Ω–ª–∞–π–Ω =====
    if (data.type === "users") {
        users.innerHTML = "";
        data.users.forEach(u => {
            const d = document.createElement("div");
            d.className = "user";
            d.innerHTML = `<span class="dot"></span>${u}`;
            users.appendChild(d);
        });
    }

    // ===== —Ç–µ–∫—Å—Ç =====
    if (data.type === "message") {
        addMsg(data.nick, data.text);
    }

    // ===== —Ñ–∞–π–ª =====
    if (data.type === "file") {
        if (data.mime.startsWith("image")) {
            addMsg(
                data.nick,
                `<img src="${data.content}" style="max-width:200px;border-radius:8px">`
            );
        } else if (data.mime.startsWith("video")) {
            addMsg(
                data.nick,
                `<video controls src="${data.content}" style="max-width:220px"></video>`
            );
        } else {
            addMsg(
                data.nick,
                `<a href="${data.content}" download="${data.name}">üìé ${data.name}</a>`
            );
        }
    }
};

function addMsg(from, html) {
    const div = document.createElement("div");
    div.className = "msg " + (from === nick ? "me" : "other");
    div.innerHTML = `<div class="nick">${from}</div>${html}`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

// ===== –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ =====
function sendMsg() {
    if (!text.value.trim()) return;
    ws.send(JSON.stringify({ type: "message", text: text.value }));
    text.value = "";
}

send.onclick = sendMsg;
text.onkeydown = e => e.key === "Enter" && sendMsg();

// ===== —ç–º–æ–¥–∑–∏ =====
emojiBtn.onclick = () => {
    emojiPanel.style.display =
        emojiPanel.style.display === "flex" ? "none" : "flex";
};

emojiPanel.onclick = e => {
    if (e.target.nodeType === 3) {
        text.value += e.target.textContent.trim();
    }
};

// ===== —Ñ–∞–π–ª =====
fileInput.onchange = () => {
    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = () => {
        ws.send(JSON.stringify({
            type: "file",
            name: file.name,
            mime: file.type,
            content: reader.result
        }));
    };

    reader.readAsDataURL(file);
};
</script>
