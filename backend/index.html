<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<h3>Ð§Ð°Ñ‚ ðŸ‘‹</h3>

<input id="nick" placeholder="ÐÐ¸Ðº">
<button onclick="setNick()">OK</button>

<div id="chat" style="height:300px;overflow:auto;border:1px solid #444;"></div>

<input id="text">
<input type="file" id="file">
<button onclick="send()">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>

<script>
let myNick = "";
const ws = new WebSocket(
 (location.protocol==="https:"?"wss://":"ws://")+location.host+"/ws"
);

ws.onmessage = e => {
 const d = JSON.parse(e.data);
 if (d.type === "system") add("âš™ï¸ "+d.text);
 if (d.type === "message") render(d);
};

function setNick(){
 myNick = nick.value;
 ws.send("/nick "+myNick);
}

function send(){
 if(text.value){
  ws.send(JSON.stringify({type:"text",data:text.value}));
  text.value="";
 }
 if(file.files[0]){
  const r=new FileReader();
  r.onload=()=>ws.send(JSON.stringify({
   type:"file",
   name:file.files[0].name,
   mime:file.files[0].type,
   data:r.result
  }));
  r.readAsDataURL(file.files[0]);
  file.value="";
 }
}

function render(d){
 if(d.text.type==="text"){
  add(`<b>${d.nick}:</b> ${d.text.data}`);
 }
 if(d.text.type==="file"){
  if(d.text.mime.startsWith("image"))
   add(`<b>${d.nick}:</b><br><img src="${d.text.data}" width=200>`);
  else if(d.text.mime.startsWith("video"))
   add(`<b>${d.nick}:</b><br><video src="${d.text.data}" controls width=240>`);
 }
}

function add(html){
 const div=document.createElement("div");
 div.innerHTML=html;
 chat.appendChild(div);
 chat.scrollTop=chat.scrollHeight;
}
</script>

</body>
</html>

