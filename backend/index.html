<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>
<link rel="icon" href="/favicon.ico">
<style>
body { margin:0; display:flex; height:100vh; background:#020617; color:white; font-family:sans-serif }
#users { width:220px; border-right:1px solid #1e293b; padding:10px }
.user { padding:5px; cursor:pointer }
.user:hover { background:#2563eb }
#chat { flex:1; display:flex; flex-direction:column }
#messages { flex:1; padding:10px; overflow-y:auto }
input,button { background:#020617; color:white; border:1px solid #334155; padding:8px }
</style>
</head>
<body>

<div id="users"></div>

<div id="chat">
  <div id="messages"></div>
  <div style="display:flex">
    <input id="to" placeholder="–ö–æ–º—É" readonly>
    <input id="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" style="flex:1">
    <button onclick="send()">‚ñ∂</button>
  </div>
</div>

<script>
let username = localStorage.getItem("username");
if (!username) {
    username = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫:");
    localStorage.setItem("username", username);
}

const ws = new WebSocket(`wss://${location.host}/ws/${username}`);
const usersDiv = document.getElementById("users");
const messagesDiv = document.getElementById("messages");

ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    console.log("WS:", data); // üëà –≤–∞–∂–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

    if (data.type === "users") {
        usersDiv.innerHTML = "<b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</b><br>";
        data.users.forEach(u => {
            if (u !== username) {
                const d = document.createElement("div");
                d.textContent = u;
                d.className = "user";
                d.onclick = () => document.getElementById("to").value = u;
                usersDiv.appendChild(d);
            }
        });
        return;
    }

    if (data.type === "message") {
        addMessage(`${data.from}: ${data.message}`);
    }
};

function send() {
    const to = document.getElementById("to").value;
    const msg = document.getElementById("message").value;
    if (!to || !msg) return;

    ws.send(JSON.stringify({ to, message: msg }));
    addMessage(`–Ø ‚Üí ${to}: ${msg}`);
    document.getElementById("message").value = "";
}

function addMessage(text) {
    const d = document.createElement("div");
    d.textContent = text;
    messagesDiv.appendChild(d);
    messagesDiv.scrollTop = messagesDiv.scrollHeight; // üî• –ê–í–¢–û–°–ö–†–û–õ–õ
}
</script>


</body>
</html>
