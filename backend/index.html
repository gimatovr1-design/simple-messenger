<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<h3>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç üëã</h3>

<!-- ===== –í–ò–î–ï–û–°–í–Ø–ó–¨ ===== -->
<div style="margin-bottom:10px;">
    <button onclick="startCall()">üé• –ù–∞—á–∞—Ç—å –≤–∏–¥–µ–æ—Å–≤—è–∑—å</button>
    <button onclick="leaveCall()">‚ùå –í—ã–π—Ç–∏</button>
</div>

<div id="videos" style="display:flex; gap:10px; flex-wrap:wrap;"></div>

<!-- ===== –í–í–û–î –ù–ò–ö–ê ===== -->
<div id="nickBox">
    <input id="nickInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫" autocomplete="off">
    <button onclick="setNick()">OK</button>
</div>

<div class="layout">

    <div id="users">
        <b>–û–Ω–ª–∞–π–Ω</b>
        <ul id="userList"></ul>
    </div>

    <div class="chatBox">
        <div id="chat"></div>

        <div class="inputBox">
            <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

</div>

<script>
let myNick = "";
let users = new Set();
let ws;
let localStream;
let peers = {};

function connectWS() {
    ws = new WebSocket(
        (location.protocol === "https:" ? "wss://" : "ws://") +
        location.host + "/ws"
    );

    ws.onmessage = async (event) => {
        let data;
        try { data = JSON.parse(event.data); } catch { return; }

        if (data.type === "message") {
            users.add(data.nick);
            renderUsers();
            addMessage(data.nick, data.text, data.nick === myNick ? "me" : "other");
        }

        if (data.type === "system") {
            addSystem(data.text);
        }

        if (data.type === "offer") await handleOffer(data);
        if (data.type === "answer") await peers[data.from].setRemoteDescription(data.answer);
        if (data.type === "candidate") await peers[data.from].addIceCandidate(data.candidate);
    };
}

connectWS();

function setNick() {
    myNick = nickInput.value.trim();
    if (!myNick) return;
    ws.send("/nick " + myNick);
    nickBox.style.display = "none";
}

function sendMessage() {
    if (messageInput.value.trim()) {
        ws.send(messageInput.value);
        messageInput.value = "";
    }
}

messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});

async function startCall() {
    localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    addVideo(myNick, localStream);

    ws.send(JSON.stringify({ type:"join_call" }));
}

function leaveCall() {
    for (let id in peers) peers[id].close();
    peers = {};
    videos.innerHTML = "";
}

async function handleOffer(data) {
    const pc = createPeer(data.from);
    await pc.setRemoteDescription(data.offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({ type:"answer", to:data.from, answer }));
}

function createPeer(id) {
    const pc = new RTCPeerConnection();
    peers[id] = pc;

    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.ontrack = e => addVideo(id, e.streams[0]);

    pc.onicecandidate = e => {
        if (e.candidate) {
            ws.send(JSON.stringify({
                type:"candidate",
                to:id,
                candidate:e.candidate
            }));
        }
    };

    return pc;
}

function addVideo(id, stream) {
    if (document.getElementById("v_"+id)) return;
    const v = document.createElement("video");
    v.id = "v_"+id;
    v.srcObject = stream;
    v.autoplay = true;
    v.playsInline = true;
    v.muted = id === myNick;
    v.style.width = "200px";
    videos.appendChild(v);
}

/* ==== —á–∞—Ç —Ñ—É–Ω–∫—Ü–∏–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ==== */
function addMessage(nick,text,side){
    const d=document.createElement("div");
    d.textContent=`${nick}: ${text}`;
    chat.appendChild(d);
}
function addSystem(t){
    const d=document.createElement("div");
    d.textContent=t;
    chat.appendChild(d);
}
function renderUsers(){
    userList.innerHTML="";
    users.forEach(u=>{
        const li=document.createElement("li");
        li.textContent=u;
        userList.appendChild(li);
    });
}
</script>

</body>
</html>

