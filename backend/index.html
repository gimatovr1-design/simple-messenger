<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<h3>Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ñ‡Ð°Ñ‚ ðŸ‘‹</h3>

<div id="nickBox">
    <input id="nickInput" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¸Ðº">
    <button onclick="setNick()">OK</button>
</div>

<!-- ===== Ð¡ÐŸÐ˜Ð¡ÐžÐš ÐžÐÐ›ÐÐ™Ð ===== -->
<div id="usersBox">
    <strong>ÐžÐ½Ð»Ð°Ð¹Ð½:</strong>
    <div id="users"></div>
</div>

<div id="chat"></div>

<div class="inputBox">
    <input id="messageInput" placeholder="Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ">
    <button onclick="sendMessage()">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
</div>

<script>
let myNick = "";
let onlineUsers = {};

let ws = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") +
    location.host + "/ws"
);

ws.onmessage = (event) => {
    let data;
    try {
        data = JSON.parse(event.data);
    } catch {
        return;
    }

    if (data.type === "system") {
        if (data.text.includes("Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡")) {
            const nick = data.text.split(": ").pop();
            onlineUsers[nick] = Date.now();
            renderUsers();
        }

        if (data.text.includes("Ð¾Ñ‚ÐºÐ»ÑŽÑ‡")) {
            const nick = data.text.split(": ").pop();
            if (onlineUsers[nick]) {
                onlineUsers[nick] = 0;
                renderUsers();
            }
        }
        return;
    }

    if (data.type === "message") {
        onlineUsers[data.nick] = Date.now();
        renderUsers();
        addMessage(
            data.nick,
            data.text,
            data.nick === myNick ? "me" : "other"
        );
    }
};

function setNick() {
    const nick = document.getElementById("nickInput").value.trim();
    if (nick) {
        myNick = nick;
        ws.send("/nick " + nick);
        document.getElementById("nickBox").style.display = "none";
    }
}

function sendMessage() {
    const input = document.getElementById("messageInput");
    if (input.value.trim()) {
        ws.send(input.value);
        input.value = "";
    }
}

document.getElementById("messageInput").addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});

function renderUsers() {
    const box = document.getElementById("users");
    box.innerHTML = "";
    Object.keys(onlineUsers).forEach(nick => {
        const div = document.createElement("div");
        div.className = "user";
        div.innerHTML = `
            <span class="dot ${onlineUsers[nick] ? 'on' : 'off'}"></span>
            ${nick}
        `;
        box.appendChild(div);
    });
}

function addMessage(nick, text, side) {
    const chat = document.getElementById("chat");

    const row = document.createElement("div");
    row.className = "row " + side + " appear";

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = nick[0].toUpperCase();

    const status = document.createElement("span");
    status.className = "online";
    if (!onlineUsers[nick]) status.classList.add("offline");
    avatar.appendChild(status);

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = `<strong>${nick}</strong><br>${text}`;

    row.appendChild(avatar);
    row.appendChild(bubble);
    chat.appendChild(row);

    chat.scrollTop = chat.scrollHeight;
}
</script>

</body>

<style>
body {
    margin: 0;
    min-height: 100vh;
    padding: 10px;
    font-family: system-ui, sans-serif;
    color: #fff;
    background:
        linear-gradient(120deg,
            rgba(140,0,255,0.45),
            rgba(0,180,255,0.45),
            rgba(255,0,140,0.45)
        ),
        url("https://images.unsplash.com/photo-1500530855697-b586d89ba3ee");
    background-size: 300% 300%, cover;
    animation: neon 20s infinite;
}

@keyframes neon {
    0% { background-position: 0% 50%, center; }
    50% { background-position: 100% 50%, center; }
    100% { background-position: 0% 50%, center; }
}

#usersBox {
    background: rgba(0,0,0,0.4);
    padding: 6px;
    border-radius: 6px;
    margin-bottom: 6px;
    font-size: 14px;
}

.user {
    display: flex;
    align-items: center;
    gap: 6px;
}

.dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}
.dot.on { background: #00ff6a; box-shadow: 0 0 6px #00ff6a; }
.dot.off { background: #ff3b3b; }

#chat {
    height: 300px;
    overflow-y: auto;
    background: rgba(0,0,0,0.45);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
}

.row {
    display: flex;
    margin-bottom: 10px;
}
.row.me { flex-direction: row-reverse; }

.bubble {
    max-width: 70%;
    padding: 8px 12px;
    border-radius: 12px;
    background: rgba(0,255,255,0.35);
}
.row.other .bubble {
    background: rgba(255,0,255,0.35);
}

.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 8px;
    position: relative;
    font-weight: bold;
}

.online {
    width: 8px;
    height: 8px;
    background: #00ff6a;
    border-radius: 50%;
    position: absolute;
    bottom: 2px;
    right: 2px;
}
.online.offline {
    background: #ff3b3b;
}

.appear {
    animation: appear 0.35s ease;
}
@keyframes appear {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.inputBox {
    display: flex;
    gap: 6px;
}
input { flex: 1; padding: 6px; }
button { padding: 6px 12px; cursor: pointer; }
</style>

</html>
