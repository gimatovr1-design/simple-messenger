<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<h3>Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ñ‡Ð°Ñ‚ ðŸ‘‹</h3>

<div id="nickBox">
    <input id="nickInput" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¸Ðº" autocomplete="off">
    <button onclick="setNick()">OK</button>
</div>

<div class="layout">

    <div id="users">
        <b>ÐžÐ½Ð»Ð°Ð¹Ð½</b>
        <ul id="userList"></ul>
    </div>

    <div class="chatBox">
        <div id="chat"></div>

        <div class="inputBox">
            <input id="messageInput" placeholder="Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ" autocomplete="off">
            <button onclick="sendMessage()">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
        </div>
    </div>

</div>

<script>
let myNick = "";
let users = new Set();

const chat = document.getElementById("chat");

const ws = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") +
    location.host + "/ws"
);

ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "online") {
        users.add(data.nick);
        renderUsers();
        system(`${data.nick} ðŸŸ¢ Ð¾Ð½Ð»Ð°Ð¹Ð½`);
        return;
    }

    if (data.type === "offline") {
        users.delete(data.nick);
        renderUsers();
        system(`${data.nick} ðŸ”´ Ð¾Ñ„Ð»Ð°Ð¹Ð½`);
        return;
    }

    if (data.type === "message") {
        const side = data.nick === myNick ? "me" : "other";
        addMessage(data.nick, data.text, side);
    }
};

function setNick() {
    const input = document.getElementById("nickInput");
    const nick = input.value.trim();
    if (!nick) return;

    myNick = nick;
    ws.send("/nick " + nick);

    input.value = "";
    document.getElementById("nickBox").style.display = "none";
}

function sendMessage() {
    const input = document.getElementById("messageInput");
    if (input.value.trim()) {
        ws.send(input.value);
        input.value = "";
    }
}

document.getElementById("messageInput").addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});

function addMessage(nick, text, side) {
    const msg = document.createElement("div");
    msg.className = "msg " + side;

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.textContent = nick[0].toUpperCase();

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = `<b>${nick}</b><br>${text}`;

    msg.appendChild(avatar);
    msg.appendChild(bubble);

    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
}

function system(text) {
    const div = document.createElement("div");
    div.className = "system";
    div.textContent = text;
    chat.appendChild(div);
}

function renderUsers() {
    const list = document.getElementById("userList");
    list.innerHTML = "";

    users.forEach(nick => {
        const li = document.createElement("li");
        li.innerHTML = `<span class="dot"></span>${nick}`;
        list.appendChild(li);
    });
}
</script>

<style>
body {
    margin: 0;
    padding: 10px;
    min-height: 100vh;
    font-family: system-ui, sans-serif;
    color: #fff;
    background: linear-gradient(120deg,#5f2cff,#00c3ff,#ff2c9c);
    background-size: 300% 300%;
    animation: bg 18s ease infinite;
}

@keyframes bg {
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
}

.layout { display:flex; gap:10px; }

#users {
    width:160px;
    background:rgba(0,0,0,.4);
    padding:8px;
    border-radius:8px;
}

#userList {
    list-style:none;
    padding:0;
}

#userList li {
    display:flex;
    gap:6px;
    align-items:center;
    margin-bottom:4px;
}

.dot {
    width:8px;
    height:8px;
    border-radius:50%;
    background:#00ff88;
}

.chatBox { flex:1; }

#chat {
    height:320px;
    overflow-y:auto;
    background:rgba(0,0,0,.4);
    border-radius:8px;
    padding:10px;
}

.msg {
    display:flex;
    margin-bottom:8px;
}

.msg.me { flex-direction:row-reverse; }

.avatar {
    width:36px;
    height:36px;
    border-radius:50%;
    background:rgba(255,255,255,.3);
    display:flex;
    align-items:center;
    justify-content:center;
    margin:0 6px;
}

.bubble {
    max-width:65%;
    padding:6px 10px;
    border-radius:10px;
    background:rgba(0,255,255,.35);
}

.msg.other .bubble {
    background:rgba(255,0,255,.35);
}

.system {
    text-align:center;
    opacity:.7;
    font-size:13px;
    margin:6px 0;
}

.inputBox {
    display:flex;
    gap:6px;
    margin-top:6px;
}

input { flex:1; padding:6px; }
button { padding:6px 12px; cursor:pointer; }
</style>

</body>
</html>
