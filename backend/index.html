<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin: 0;
    padding: 10px;
    min-height: 100dvh;
    font-family: system-ui, sans-serif;
    color: #fff;
    background: linear-gradient(120deg,#7f00ff,#00c6ff,#ff0080);
    font-size: clamp(14px, 2.5vw, 16px);
}
#loginBox,#nickBox,#chatApp{max-width:1000px;margin:auto}
#loginBox{max-width:320px;background:rgba(0,0,0,.45);padding:20px;border-radius:12px}
.layout{display:flex;gap:10px}
#users{width:180px;background:rgba(0,0,0,.45);padding:8px;border-radius:8px}
.chatBox{flex:1;display:flex;flex-direction:column}
#chat{flex:1;min-height:300px;overflow-y:auto;background:rgba(0,0,0,.45);border-radius:8px;padding:10px}
.msg{display:flex;margin-bottom:8px}
.msg.me{flex-direction:row-reverse}
.avatar{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;margin:0 6px;font-weight:bold}
.bubble{max-width:65%;padding:6px 10px;border-radius:10px;background:rgba(0,255,255,.35);word-break:break-word}
.msg.other .bubble{background:rgba(255,0,255,.35)}
.system{text-align:center;font-size:13px;opacity:.8;margin:6px 0}
.inputBox{display:flex;gap:6px;margin-top:6px}
input,button{width:100%;padding:10px;margin-top:6px;font-size:16px}
#emojiPanel{display:none;background:rgba(0,0,0,.5);padding:6px;border-radius:8px;margin-top:6px;max-height:120px;overflow-y:auto}
#emojiPanel span{cursor:pointer;font-size:20px;padding:4px;display:inline-block}
@media(max-width:768px){.layout{flex-direction:column}#users{width:100%}.bubble{max-width:85%}}
</style>
</head>

<body>

<div id="loginBox">
    <h3 id="authTitle">–í—Ö–æ–¥ üîê</h3>
    <input id="phoneInput" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
    <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="authSubmit()">–í–æ–π—Ç–∏</button>
    <div id="authSwitch" style="cursor:pointer;margin-top:10px" onclick="toggleAuth()">
        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
    </div>
</div>

<div id="nickBox" style="display:none">
    <input id="nickInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫">
    <button onclick="setNick()">OK</button>
</div>

<div id="chatApp" style="display:none">
<div class="layout">

    <div id="users">
        <b>–û–Ω–ª–∞–π–Ω</b>
        <ul id="userList"></ul>
        <button onclick="clearChat()">üóë –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
        <button onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
    </div>

    <div class="chatBox">
        <div id="chat"></div>
        <div id="emojiPanel"></div>

        <div class="inputBox">
            <button onclick="toggleEmoji()">üòÄ</button>
            <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

</div>
</div>

<script>
let ws = null;
let myNick = "";
let authMode = "login";

const emojis="üòÄ üòÅ üòÇ ü§£ üòÉ üòÑ üòÖ üòÜ üòâ üòä üòé üòç üòò ü§î üòê üôÑ üò¥ üò° üò≠ üò± üëç üëé üëè üôå üí™ ‚ù§ üíî üî• üéâ".split(" ");

function toggleAuth(){
    authMode = authMode==="login"?"register":"login";
    authTitle.innerText = authMode==="login"?"–í—Ö–æ–¥ üîê":"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è üì±";
}

function authSubmit(){ authMode==="login"?login():register(); }

function login(){
fetch("/login",{method:"POST",credentials:"include",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({phone:phoneInput.value,password:passwordInput.value})})
.then(r=>r.json()).then(d=>{ if(d.ok) startApp(); });
}

function register(){
fetch("/register",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({phone:phoneInput.value,password:passwordInput.value})})
.then(()=>alert("‚úÖ –ì–æ—Ç–æ–≤–æ"));
}

function startApp(){
ws = new WebSocket((location.protocol==="https:"?"wss":"ws")+"://"+location.host+"/ws");

ws.onmessage = e=>{
    const d = JSON.parse(e.data);

    if(d.type==="message"){
        addMessage(d.nick,d.text,d.nick===myNick?"me":"other");
    }
    if(d.type==="system"){
        addSystem(d.text);
    }
    if(d.type==="users"){
        updateUsers(d.users);
    }
};

loginBox.style.display="none";
chatApp.style.display="block";
nickBox.style.display="block";
}

function setNick(){
myNick = nickInput.value.trim();
if(myNick){
    ws.send("/nick "+myNick);
    nickBox.style.display="none";
}
}

function sendMessage(){
if(messageInput.value.trim()){
    ws.send(messageInput.value);
    messageInput.value="";
}}

function clearChat(){
fetch("/clear",{method:"POST",credentials:"include"}).then(()=>{
    chat.innerHTML="";
});
}

function logout(){
fetch("/logout",{method:"POST",credentials:"include"})
.then(()=>location.reload());
}

function addMessage(n,t,s){
const m=document.createElement("div");
m.className="msg "+s;
m.innerHTML=`<div class="avatar">${n[0]}</div>
<div class="bubble"><b>${n}</b><br>${t}</div>`;
chat.appendChild(m);
chat.scrollTop=chat.scrollHeight;
}

function addSystem(t){
const s=document.createElement("div");
s.className="system";
s.textContent=t;
chat.appendChild(s);
chat.scrollTop=chat.scrollHeight;
}

function updateUsers(u){
userList.innerHTML="";
u.forEach(n=>{
    const li=document.createElement("li");
    li.textContent="üü¢ "+n;
    userList.appendChild(li);
});
}

function toggleEmoji(){
emojiPanel.style.display=emojiPanel.style.display==="block"?"none":"block";
}

emojis.forEach(e=>{
const s=document.createElement("span");
s.textContent=e;
s.onclick=()=>messageInput.value+=e;
emojiPanel.appendChild(s);
});
</script>

</body>
</html>
