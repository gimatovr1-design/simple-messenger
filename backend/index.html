<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>

<style>
* { box-sizing: border-box; }

body {
    margin: 0;
    background: #0d0d0d;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    color: #fff;
}

#chat {
    width: 360px;
    height: 520px;
    background: #111;
    display: flex;
    flex-direction: column;
    border-radius: 12px;
    box-shadow: 0 0 25px rgba(0,0,0,0.8);
    overflow: hidden;
}

header {
    padding: 10px;
    background: #1a1a1a;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
}

#nickname { font-weight: bold; }
#changeNick { cursor: pointer; opacity: .7; }
#changeNick:hover { opacity: 1; }

#status { font-size: 12px; }

#notify {
    display: none;
    background: #ff4444;
    color: #000;
    text-align: center;
    padding: 6px;
    font-size: 13px;
}

#messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    font-size: 14px;
}

.message { margin-bottom: 6px; word-break: break-word; }
.time { color: #777; font-size: 11px; margin-right: 6px; }
.system { color: #888; font-style: italic; }

footer {
    display: flex;
    padding: 8px;
    background: #1a1a1a;
}

input {
    flex: 1;
    padding: 6px;
    font-size: 14px;
    border: none;
    outline: none;
}

button {
    padding: 6px 12px;
    margin-left: 6px;
    font-size: 14px;
    cursor: pointer;
}
</style>
</head>

<body>

<div id="chat">

<header>
    <div>
        <span id="nickname"></span>
        <span id="changeNick">‚úé</span>
    </div>
    <div id="status">üî¥ offline</div>
</header>

<div id="notify">‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ</div>
<div id="messages"></div>

<footer>
    <input id="input" type="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." disabled>
    <button id="sendBtn" disabled>‚û§</button>
</footer>

</div>

<script>
let ws = null;
let reconnectTimer = null;

const statusEl = document.getElementById("status");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const messages = document.getElementById("messages");
const notify = document.getElementById("notify");
const nickEl = document.getElementById("nickname");
const changeNickBtn = document.getElementById("changeNick");

/* === NICK (SESSION ONLY) === */
let nickname = "–ì–æ—Å—Ç—å";
nickEl.textContent = nickname;

changeNickBtn.onclick = () => {
    const n = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–∏–∫:", nickname);
    if (!n) return;
    const t = n.trim();
    if (!t) return;
    nickname = t;
    nickEl.textContent = nickname;
    addMessage(`–ù–∏–∫ –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ "${nickname}"`, "system");
};

function now() {
    return new Date().toLocaleTimeString("ru-RU", {
        hour: "2-digit",
        minute: "2-digit"
    });
}

function addMessage(text, cls = "") {
    const div = document.createElement("div");
    div.className = "message " + cls;

    const time = document.createElement("span");
    time.className = "time";
    time.textContent = now();

    const msg = document.createElement("span");
    msg.textContent = text;

    div.append(time, msg);
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

function setOnline(state) {
    statusEl.textContent = state ? "üü¢ online" : "üî¥ offline";
    notify.style.display = state ? "none" : "block";
    input.disabled = !state;
    sendBtn.disabled = !state;
    if (state) input.focus();
}

function connect() {
    ws = new WebSocket(
        (location.protocol === "https:" ? "wss://" : "ws://") +
        location.host + "/ws"
    );

    ws.onopen = () => {
        setOnline(true);
        addMessage("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "system");
        clearTimeout(reconnectTimer);
    };

    ws.onmessage = e => addMessage(e.data);

    ws.onclose = () => {
        setOnline(false);
        addMessage("–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...", "system");
        reconnectTimer = setTimeout(connect, 2000);
    };
}

function sendMessage() {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;

    const text = input.value.trim();
    if (!text) return;

    if (text.startsWith(nickname + ":")) {
        ws.send(text);
    } else {
        ws.send(`${nickname}: ${text}`);
    }

    input.value = "";
}

sendBtn.onclick = sendMessage;
input.onkeydown = e => e.key === "Enter" && sendMessage();

connect();
</script>

</body>
</html>
