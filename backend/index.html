<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Private Chat</title>
<style>
body {
    background: #0b1220;
    color: white;
    font-family: Arial;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}
#login, #chat {
    background: #111a2e;
    padding: 20px;
    border-radius: 12px;
    width: 340px;
}
#chat { display: none; }
#users div {
    cursor: pointer;
    padding: 5px;
}
#users div:hover {
    background: #1e2a44;
}
#users .active {
    background: #00bfff;
}
#messages {
    height: 160px;
    overflow-y: auto;
    border: 1px solid #222;
    margin: 10px 0;
    padding: 5px;
}
</style>
</head>
<body>

<div id="login">
    <h3>Вход</h3>
    <input id="username" placeholder="Ваш ник">
    <button onclick="enter()">Войти</button>
</div>

<div id="chat">
    <div><b>Пользователи:</b></div>
    <div id="users"></div>
    <hr>
    <div id="messages"></div>
    <input id="message" placeholder="Сообщение">
    <button onclick="send()">Отправить</button>
</div>

<script>
let ws;
let username = localStorage.getItem("username") || "";
let currentUser = "";

document.getElementById("username").value = username;

function enter() {
    username = document.getElementById("username").value.trim();
    if (!username) return alert("Введите ник");

    localStorage.setItem("username", username);

    document.getElementById("login").style.display = "none";
    document.getElementById("chat").style.display = "block";

    const proto = location.protocol === "https:" ? "wss://" : "ws://";
    ws = new WebSocket(proto + location.host + "/ws/chat");

    ws.onopen = () => {
        ws.send("__join__" + username);
    };

    ws.onmessage = (e) => {
        if (e.data.startsWith("__users__")) {
            renderUsers(e.data.replace("__users__", "").split(","));
        } else {
            addMessage(e.data);
        }
    };
}

function renderUsers(list) {
    const box = document.getElementById("users");
    box.innerHTML = "";

    list.forEach(u => {
        if (!u || u === username) return;

        const div = document.createElement("div");
        div.textContent = u;
        div.onclick = () => {
            currentUser = u;
            document.querySelectorAll("#users div").forEach(x => x.classList.remove("active"));
            div.classList.add("active");
            document.getElementById("messages").innerHTML = "";
        };
        box.appendChild(div);
    });
}

function send() {
    if (!currentUser) return alert("Выбери пользователя");

    const input = document.getElementById("message");
    const text = input.value.trim();
    if (!text) return;

    ws.send(`__to__${currentUser}|${text}`);
    input.value = "";
}

function addMessage(text) {
    const d = document.createElement("div");
    d.textContent = text;
    document.getElementById("messages").appendChild(d);
}
</script>

</body>
</html>

