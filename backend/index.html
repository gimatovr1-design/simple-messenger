<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>

<h3>Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ñ‡Ğ°Ñ‚ ğŸ‘‹</h3>

<div id="nickBox">
    <input id="nickInput" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ¸Ğº">
    <button onclick="setNick()">OK</button>
</div>

<div class="layout">

<div id="users">
    <b>ĞĞ½Ğ»Ğ°Ğ¹Ğ½</b>
    <ul id="userList"></ul>
</div>

<div class="chatBox">
    <div id="chat"></div>

    <div class="inputBox">
        <input type="file" id="fileInput" accept="image/*,video/*" hidden>
        <button onclick="selectFile()">ğŸ“</button>
        <button onclick="toggleEmoji()">ğŸ˜„</button>
        <input id="messageInput" placeholder="Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ">
        <button onclick="sendMessage()">ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ</button>
    </div>

    <div id="emojiBox" style="display:none">
        ğŸ˜€ ğŸ˜ ğŸ˜‚ ğŸ¤£ ğŸ˜Š ğŸ˜ ğŸ˜ ğŸ˜­ ğŸ˜¡ ğŸ‘ ğŸ‘ â¤ï¸ ğŸ”¥ ğŸ‰
    </div>
</div>

</div>

<script>
let myNick = "";
let users = new Set();

let ws = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") +
    location.host + "/ws"
);

ws.onmessage = (event) => {
    let data;
    try { data = JSON.parse(event.data); } catch { return; }

    if (data.type === "system") {
        addSystem(data.text);
        return;
    }

    if (data.type === "message") {
        users.add(data.nick);
        renderUsers();
        addMessage(data.nick, data.text, data.nick === myNick ? "me" : "other");
    }
};

function setNick() {
    const nick = nickInput.value.trim();
    if (!nick) return;
    myNick = nick;
    ws.send("/nick " + nick);
    nickBox.style.display = "none";
}

function sendMessage() {
    const v = messageInput.value.trim();
    if (!v) return;
    ws.send(v);
    messageInput.value = "";
}

messageInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});

function addMessage(nick, text, side) {
    const msg = document.createElement("div");
    msg.className = "msg " + side;

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    if (text.startsWith("/uploads/")) {
        if (text.match(/\.(mp4|webm|ogg)$/)) {
            bubble.innerHTML = `<b>${nick}</b><br>
            <video src="${text}" controls style="max-width:240px;border-radius:8px"></video>`;
        } else {
            bubble.innerHTML = `<b>${nick}</b><br>
            <img src="${text}" style="max-width:240px;border-radius:8px">`;
        }
    } else {
        bubble.innerHTML = `<b>${nick}</b><br>${text}`;
    }

    msg.appendChild(bubble);
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
}

function addSystem(text) {
    const d = document.createElement("div");
    d.className = "system";
    d.textContent = text;
    chat.appendChild(d);
}

function renderUsers() {
    userList.innerHTML = "";
    users.forEach(u => {
        const li = document.createElement("li");
        li.textContent = u;
        userList.appendChild(li);
    });
}

// ===== Ğ¤ĞĞ™Ğ›Ğ« (Ğ¤ĞĞ¢Ğ + Ğ’Ğ˜Ğ”Ğ•Ğ) =====
function selectFile() {
    fileInput.click();
}

fileInput.onchange = async () => {
    const file = fileInput.files[0];
    if (!file) return;

    const fd = new FormData();
    fd.append("file", file);

    const r = await fetch("/upload", {
        method: "POST",
        body: fd
    });

    const d = await r.json();
    ws.send(d.url);
    fileInput.value = "";
};

// ===== Ğ­ĞœĞĞ”Ğ—Ğ˜ =====
function toggleEmoji() {
    emojiBox.style.display =
        emojiBox.style.display === "none" ? "block" : "none";
}

emojiBox.onclick = e => {
    if (!e.target.textContent.trim()) return;
    messageInput.value += e.target.textContent;
    emojiBox.style.display = "none";
};
</script>

<style>
body {
    margin:0; padding:10px;
    font-family:system-ui;
    color:#fff;
    background: linear-gradient(120deg,#8c00ff,#00b4ff,#ff008c);
}
.layout { display:flex; gap:10px; }
#users { width:150px; background:#0006; padding:8px; }
.chatBox { flex:1; }
#chat { height:320px; overflow:auto; background:#0006; padding:10px; }
.msg { margin-bottom:6px; }
.msg.me { text-align:right; }
.bubble { display:inline-block; padding:6px 10px; background:#0ff6; border-radius:8px; }
.system { text-align:center; opacity:.7; }
.inputBox { display:flex; gap:5px; margin-top:5px; }
#emojiBox { background:#0008; padding:6px; cursor:pointer; }
</style>

</body>
</html>
