<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Simple Messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* === –°–¢–ò–õ–ò –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô === */
body {
    margin: 0;
    padding: 10px;
    min-height: 100vh;
    font-family: system-ui, sans-serif;
    color: #fff;
    background: linear-gradient(120deg,#7f00ff,#00c6ff,#ff0080);
}

#loginBox {
    max-width: 320px;
    margin: auto;
    background: rgba(0,0,0,.45);
    padding: 20px;
    border-radius: 12px;
}

.layout { display: flex; gap: 10px; }

#users {
    width: 160px;
    background: rgba(0,0,0,.45);
    padding: 8px;
    border-radius: 8px;
}

.chatBox { flex: 1; }

#chat {
    height: 320px;
    overflow-y: auto;
    background: rgba(0,0,0,.45);
    border-radius: 8px;
    padding: 10px;
}

.msg { display: flex; margin-bottom: 8px; }
.msg.me { flex-direction: row-reverse; }

.avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255,255,255,.2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 6px;
    font-weight: bold;
}

.bubble {
    max-width: 65%;
    padding: 6px 10px;
    border-radius: 10px;
    background: rgba(0,255,255,.35);
}

.msg.other .bubble {
    background: rgba(255,0,255,.35);
}

.system {
    text-align: center;
    font-size: 13px;
    opacity: .8;
    margin: 6px 0;
}

.inputBox {
    display: flex;
    gap: 6px;
    margin-top: 6px;
}

#emojiPanel {
    display: none;
    background: rgba(0,0,0,.5);
    padding: 6px;
    border-radius: 8px;
    margin-top: 6px;
    max-height: 120px;
    overflow-y: auto;
}

#emojiPanel span {
    cursor: pointer;
    font-size: 20px;
    padding: 4px;
    display: inline-block;
}

input, button {
    width: 100%;
    padding: 8px;
    margin-top: 6px;
}
</style>
</head>

<body>

<div id="loginBox">
    <h3 id="authTitle">–í—Ö–æ–¥ üîê</h3>

    <input id="phoneInput" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
    <input id="passwordInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å">

    <button onclick="authSubmit()">–í–æ–π—Ç–∏</button>

    <div id="authSwitch"
         style="cursor:pointer;margin-top:10px;opacity:.85"
         onclick="toggleAuth()">
        –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
    </div>
</div>

<div id="nickBox" style="display:none">
    <input id="nickInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫">
    <button onclick="setNick()">OK</button>
</div>

<div id="chatApp" style="display:none">
<div class="layout">

    <div id="users">
        <b>–û–Ω–ª–∞–π–Ω</b>
        <ul id="userList"></ul>
    </div>

    <div class="chatBox">
        <div id="chat"></div>
        <div id="emojiPanel"></div>

        <div class="inputBox">
            <button onclick="toggleEmoji()">üòÄ</button>
            <input id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
            <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

</div>
</div>

<script>
let ws = null;
let myNick = "";
let authMode = "login";

const emojis = "üòÄ üòÅ üòÇ ü§£ üòÉ üòÑ üòÖ üòÜ üòâ üòä üòã üòé üòç üòò üòó üòô üòö üôÇ ü§ó ü§© ü§î ü§® üòê üòë üò∂ üôÑ üòè üò£ üò• üòÆ ü§ê üòØ üò™ üò´ üò¥ üòå üòõ üòú üòù ü§§ üòí üòì üòî üòï üôÉ ü•∞ üòá ü§™ üò° üò† ü§¨ üò§ üò≠ üò¢ üò± üò® üò∞ üò≤ ü§Ø üëç üëé üëè üôå ü§ù üí™ üôè ‚ù§ üíî üíñ üíï üíØ üî• üéâ".split(" ");

function toggleAuth(){
    authMode = authMode === "login" ? "register" : "login";
    authTitle.innerText = authMode === "login" ? "–í—Ö–æ–¥ üîê" : "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è üì±";
    document.querySelector("#loginBox button").innerText =
        authMode === "login" ? "–í–æ–π—Ç–∏" : "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è";
}

function authSubmit(){
    authMode === "login" ? login() : register();
}

function login(){
    fetch("/login", {
        method:"POST",
        credentials: "include",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            phone: phoneInput.value.trim(),
            password: passwordInput.value.trim()
        })
    })
    .then(r=>r.json())
    .then(d=>{
        if(d.status !== "ok"){
            alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ ‚ùå");
            return;
        }
        startApp();
    });
}

function register(){
    fetch("/register", {
        method:"POST",
        credentials: "include",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
            phone: phoneInput.value.trim(),
            password: passwordInput.value.trim()
        })
    })
    .then(r=>r.json())
    .then(d=>{
        if(d.status !== "ok"){
            alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚ùå");
            return;
        }
        toggleAuth();
        alert("‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω");
    });
}

function startApp(){
    ws = new WebSocket(
        (location.protocol==="https:"?"wss":"ws")
        + "://" + location.host + "/ws"
    );
    ws.onmessage = handleWS;

    loginBox.style.display="none";
    chatApp.style.display="block";
    nickBox.style.display="block";
}

function setNick(){
    myNick = nickInput.value.trim();
    if(myNick) ws.send("/nick " + myNick);
    nickBox.style.display="none";
}

function handleWS(e){
    const d = JSON.parse(e.data);

    if(d.type === "message"){
        addMessage(d.nick, d.text, d.nick === myNick ? "me" : "other");
    }
    if(d.type === "system"){
        addSystem(d.text);
    }
    if(d.type === "users"){
        updateUsers(d.users);
    }
}

function sendMessage(){
    if(messageInput.value.trim()){
        ws.send(messageInput.value);
        messageInput.value = "";
    }
}

function addMessage(nick, text, side){
    const m = document.createElement("div");
    m.className = "msg " + side;
    m.innerHTML = `
        <div class="avatar">${nick[0]}</div>
        <div class="bubble"><b>${nick}</b><br>${text}</div>
    `;
    chat.appendChild(m);
    chat.scrollTop = chat.scrollHeight;
}

function addSystem(text){
    const s = document.createElement("div");
    s.className = "system";
    s.textContent = text;
    chat.appendChild(s);
    chat.scrollTop = chat.scrollHeight;
}

function updateUsers(users){
    userList.innerHTML = "";
    users.forEach(u=>{
        const li = document.createElement("li");
        li.textContent = "üü¢ " + u;
        userList.appendChild(li);
    });
}

function toggleEmoji(){
    emojiPanel.style.display =
        emojiPanel.style.display === "block" ? "none" : "block";
}

emojis.forEach(e=>{
    const s = document.createElement("span");
    s.textContent = e;
    s.onclick = () => messageInput.value += e;
    emojiPanel.appendChild(s);
});

window.onload = () => {
    fetch("/me", { credentials: "include" })
        .then(r=>r.json())
        .then(d=>{
            if(d.auth) startApp();
        });
};
</script>

</body>
</html>
