<script>
const protocol = location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(`${protocol}://${location.host}/ws`);

let myNick = "";

ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    const messages = document.getElementById("messages");

    // системные
    if (data.type === "system") {
        const msg = document.createElement("div");
        msg.className = "msg other";
        msg.textContent = data.text;
        messages.appendChild(msg);
        msg.scrollIntoView({ behavior: "smooth" });
        return;
    }

    // обычные
    if (data.type === "message") {
        const msg = document.createElement("div");
        msg.classList.add("msg");

        if (data.nick === myNick) {
            msg.classList.add("me");
            msg.textContent = data.text;
        } else {
            msg.classList.add("other");
            msg.textContent = `${data.nick}: ${data.text}`;
        }

        messages.appendChild(msg);
        msg.scrollIntoView({ behavior: "smooth" });
    }
};

function setNick() {
    const nickInput = document.getElementById("nick");
    const nick = nickInput.value.trim();
    if (!nick) return;
    myNick = nick;
    ws.send("/nick " + nick);
}

function sendMessage() {
    const input = document.getElementById("text");
    const text = input.value.trim();
    if (!text) return;
    ws.send(text);
    input.value = "";
}
</script>
