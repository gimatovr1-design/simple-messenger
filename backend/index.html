<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Encrypted Chat</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

<style>
body {
    background:#0b1220;color:white;font-family:Arial;
    display:flex;justify-content:center;align-items:center;height:100vh
}
#login,#chat{background:#111a2e;padding:20px;border-radius:12px;width:340px}
#chat{display:none}
#users div{cursor:pointer;padding:5px}
#users .active{background:#00bfff}
#messages{height:160px;overflow-y:auto;border:1px solid #222;margin:10px 0;padding:5px}
#status{font-size:12px;opacity:.7}
</style>
</head>
<body>

<div id="login">
    <h3>–í—Ö–æ–¥</h3>
    <input id="username" placeholder="–í–∞—à –Ω–∏–∫">
    <button onclick="enter()">–í–æ–π—Ç–∏</button>
</div>

<div id="chat">
    <div id="status">üî¥ offline</div>
    <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</b>
    <div id="users"></div>
    <hr>
    <div id="messages"></div>
    <input id="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
    <button onclick="send()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</div>

<script>
let ws, currentUser="";
let username = localStorage.getItem("username") || "";

document.getElementById("username").value = username;

function keyFor(user){
    return [username,user].sort().join("_secret_");
}

function encrypt(text, user){
    return CryptoJS.AES.encrypt(text, keyFor(user)).toString();
}

function decrypt(text, user){
    try{
        return CryptoJS.AES.decrypt(text, keyFor(user)).toString(CryptoJS.enc.Utf8);
    }catch{ return "üîí encrypted"; }
}

function connect(){
    const proto = location.protocol==="https:"?"wss://":"ws://";
    ws = new WebSocket(proto + location.host + "/ws/chat");

    ws.onopen = ()=>{
        setStatus("üü¢ online");
        ws.send("__join__"+username);
    };

    ws.onmessage = e=>{
        if(e.data.startsWith("__users__")){
            renderUsers(e.data.replace("__users__","").split(","));
        }else{
            let [from,msg] = e.data.split(": ",2);
            addMessage(from+": "+decrypt(msg, from));
        }
    };

    ws.onclose = ()=>{
        setStatus("üî¥ reconnecting...");
        setTimeout(connect,2000);
    };
}

function enter(){
    username=document.getElementById("username").value.trim();
    if(!username)return;
    localStorage.setItem("username",username);
    document.getElementById("login").style.display="none";
    document.getElementById("chat").style.display="block";
    connect();
}

function renderUsers(list){
    const box=document.getElementById("users");
    box.innerHTML="";
    list.forEach(u=>{
        if(!u||u===username)return;
        const d=document.createElement("div");
        d.textContent=u;
        d.onclick=()=>{
            currentUser=u;
            document.querySelectorAll("#users div").forEach(x=>x.classList.remove("active"));
            d.classList.add("active");
            document.getElementById("messages").innerHTML="";
        };
        box.appendChild(d);
    });
}

function send(){
    if(!currentUser)return alert("–í—ã–±–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
    const i=document.getElementById("message");
    if(!i.value)return;
    ws.send(`__to__${currentUser}|${encrypt(i.value,currentUser)}`);
    addMessage("–í—ã",i.value);
    i.value="";
}

function addMessage(t){
    const d=document.createElement("div");
    d.textContent=t;
    document.getElementById("messages").appendChild(d);
}

function setStatus(t){document.getElementById("status").textContent=t}

if(username){
    document.getElementById("login").style.display="none";
    document.getElementById("chat").style.display="block";
    connect();
}
</script>
</body>
</html>
